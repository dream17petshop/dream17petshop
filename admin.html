<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤¢17ç²¾å“å¯µç‰©ç¾å®¹æ—…é¤¨ | å¾Œå°ç®¡ç†</title>
    <link rel="manifest" href="manifest-admin.json">
    <meta name="theme-color" content="#5C4D42">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dream: {
                            navy: '#5C4D42',
                            gold: '#C5A065',
                            cream: '#FAF8F5',
                            line: '#06C755',
                            red: '#E05D5D'
                        }
                    },
                    animation: {
                        'blob': 'blob 12s infinite',
                        'fade-up': 'fadeUp 0.8s ease-out forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-down': 'slideDown 0.3s ease-out forwards',
                        'shake': 'shake 0.4s ease-in-out',
                    },
                    keyframes: {
                        blob: {
                            '0%, 100%': { transform: 'translate(0, 0) scale(1)' },
                            '33%': { transform: 'translate(40px, -60px) scale(1.1)' },
                            '66%': { transform: 'translate(-30px, 30px) scale(0.9)' },
                        },
                        fadeUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '25%': { transform: 'translateX(-4px)' },
                            '75%': { transform: 'translateX(4px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { 
            background: #FAF8F5;
            font-family: 'Noto Sans TC', sans-serif;
            color: #5C4D42;
            -webkit-font-smoothing: antialiased; 
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.3));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-top: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(92, 77, 66, 0.08);
        }

        .glass-button {
            position: relative;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }
        .glass-button:hover {
            transform: translateY(-3px);
            border-color: rgba(197, 160, 101, 0.5);
            box-shadow: 0 15px 30px -10px rgba(197, 160, 101, 0.25);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 20px rgba(92, 77, 66, 0.03);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(200, 200, 200, 0.5);
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: #fff;
            border-color: #C5A065;
            box-shadow: 0 0 0 3px rgba(197, 160, 101, 0.1);
            outline: none;
        }

        .shake { animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both; }
        .touch-none { touch-action: none; }
        
        .fullscreen-modal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background-color: white;
            display: flex;
            flex-direction: column;
        }
        
        /* åˆ—å°æ¨£å¼ */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
const { useState, useEffect, useRef, useMemo, useCallback, memo } = React;

// --- Lucide Icon Component ---
const Icon = memo(({ name, size = 20, className = "" }) => {
    const iconRef = useRef(null);
    useEffect(() => {
        if (typeof window.lucide !== 'undefined' && iconRef.current) {
            window.lucide.createIcons({
                root: iconRef.current, 
                attrs: { "stroke-width": 2, class: className }, 
                name: name, 
                nameAttr: 'data-lucide'
            });
        }
    }, [name, className]);
    return <span ref={iconRef} className="inline-flex items-center justify-center"><i data-lucide={name} style={{ width: size, height: size }}></i></span>;
});

// --- Toast Component ---
const Toast = memo(({ message, type = 'success', onClose }) => {
    const [isVisible, setIsVisible] = useState(false);
    
    useEffect(() => {
        setIsVisible(true);
        const timer = setTimeout(() => {
            setIsVisible(false);
            setTimeout(onClose, 300);
        }, 3000);
        return () => clearTimeout(timer);
    }, [onClose]);

    const toastStyles = {
        success: 'bg-dream-line text-white',
        error: 'bg-dream-red text-white',
        warning: 'bg-dream-gold text-white'
    };

    const icons = {
        success: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
        error: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
        warning: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    };

    return (
        <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[200] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 transition-all duration-300 ${
            isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-4'
        } ${toastStyles[type]}`}>
            <div className="flex-shrink-0">
                {icons[type]}
            </div>
            <p className="font-bold text-sm">{message}</p>
        </div>
    );
});

// --- Status Badge Component ---
const StatusBadge = ({ status }) => {
    const statusConfig = {
        pending: { label: 'å¾…è™•ç†', bgColor: 'bg-yellow-100', textColor: 'text-yellow-700' },
        confirmed: { label: 'å·²ç¢ºèª', bgColor: 'bg-blue-100', textColor: 'text-blue-700' },
        completed: { label: 'å·²å®Œæˆ', bgColor: 'bg-green-100', textColor: 'text-green-700' },
        cancelled: { label: 'å·²å–æ¶ˆ', bgColor: 'bg-red-100', textColor: 'text-red-700' }
    };
    
    const config = statusConfig[status] || statusConfig.pending;
    
    return (
        <span className={`px-2 py-1 rounded-full text-xs font-bold ${config.bgColor} ${config.textColor}`}>
            {config.label}
        </span>
    );
};

// --- Skeleton Card Component ---
const SkeletonCard = () => (
    <div className="glass-panel p-4 rounded-2xl animate-pulse">
        <div className="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
        <div className="h-3 bg-gray-200 rounded w-1/2 mb-4"></div>
        <div className="space-y-2">
            <div className="h-3 bg-gray-200 rounded"></div>
            <div className="h-3 bg-gray-200 rounded w-5/6"></div>
        </div>
    </div>
);

// --- Detail Item Component ---
const DetailItem = ({ label, value, fieldName, fullWidth = false, isMultiline = false, isEditing, editForm, handleEditChange }) => {
    if (isEditing && fieldName) {
        const editVal = Array.isArray(editForm[fieldName]) ? editForm[fieldName].join(',') : (editForm[fieldName] || '');
        return (
            <div className={`${fullWidth ? 'col-span-2' : ''} bg-white p-3 rounded-xl border-2 border-dream-gold/50`}>
                <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">{label}</label>
                {isMultiline ? (
                    <textarea className="w-full edit-input h-24" value={editVal} onChange={e => handleEditChange(fieldName, e.target.value)} />
                ) : (
                    <input type={fieldName.includes('date') ? 'date' : 'text'} className="w-full edit-input" value={editVal} onChange={e => handleEditChange(fieldName, e.target.value)} />
                )}
            </div>
        );
    }
    if (!value || value === 'ç„¡' || (Array.isArray(value) && value.length === 0)) return null;
    return (
        <div className={`${fullWidth ? 'col-span-2' : ''} bg-dream-cream p-3 rounded-xl border border-white/50`}>
            <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">{label}</label>
            <div className="font-bold text-dream-navy text-sm break-words">
                {Array.isArray(value) ? value.join(', ') : value}
            </div>
        </div>
    );
};

// --- Dashboard Charts Component ---
const DashboardCharts = ({ bookings }) => {
    const chartRef1 = useRef(null);
    const chartRef2 = useRef(null);
    const chart1Instance = useRef(null);
    const chart2Instance = useRef(null);

    useEffect(() => {
        if (!bookings || bookings.length === 0 || !chartRef1.current || !chartRef2.current) return;

        // Monthly trend chart
        const monthlyData = {};
        bookings.forEach(b => {
            const month = b.created_at?.substring(0, 7);
            if (month) {
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            }
        });

        const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
        
        if (chart1Instance.current) chart1Instance.current.destroy();
        if (chartRef1.current) {
            chart1Instance.current = new Chart(chartRef1.current, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => m.replace('-', '/')),
                    datasets: [{
                        label: 'è¨‚å–®æ•¸',
                        data: sortedMonths.map(m => monthlyData[m]),
                        borderColor: '#5C4D42',
                        backgroundColor: 'rgba(92, 77, 66, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Service type distribution
        const serviceData = {};
        bookings.forEach(b => {
            const type = b.service_tags?.includes('ä½å®¿') || b.view === 'boarding' ? 'ä½å®¿' : 
                      b.service_tags?.includes('æ´—æ¾¡') || b.service_tags?.includes('å‰ªæ¯›') || b.view === 'grooming' ? 'ç¾å®¹' : 'å…¶ä»–';
            serviceData[type] = (serviceData[type] || 0) + 1;
        });

        if (chart2Instance.current) chart2Instance.current.destroy();
        if (chartRef2.current) {
            chart2Instance.current = new Chart(chartRef2.current, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(serviceData),
                    datasets: [{
                        data: Object.values(serviceData),
                        backgroundColor: ['#C5A065', '#5C4D42', '#06C755', '#3b82f6', '#E05D5D', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        return () => {
            if (chart1Instance.current) chart1Instance.current.destroy();
            if (chart2Instance.current) chart2Instance.current.destroy();
        };
    }, [bookings]);

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="glass-panel p-4 rounded-2xl">
                <h4 className="text-sm font-bold text-dream-navy mb-3">æœˆåº¦è¨‚å–®è¶¨å‹¢</h4>
                <div className="h-40">
                    <canvas ref={chartRef1}></canvas>
                </div>
            </div>
            <div className="glass-panel p-4 rounded-2xl">
                <h4 className="text-sm font-bold text-dream-navy mb-3">æœå‹™é¡å‹åˆ†ä½ˆ</h4>
                <div className="h-40">
                    <canvas ref={chartRef2}></canvas>
                </div>
            </div>
        </div>
    );
};

// --- Calendar View Component ---
const CalendarView = ({ bookings, onSelectBooking }) => {
    const [currentDate, setCurrentDate] = useState(new Date());
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    
    const days = [];
    for (let i = 0; i < startDay; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(i);
    
    const getBookingsForDay = (day) => {
        if (!day) return [];
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        return bookings.filter(b => {
            if (b.checkin_date && b.checkout_date) {
                return dateStr >= b.checkin_date && dateStr <= b.checkout_date;
            }
            return b.created_at?.startsWith(dateStr);
        });
    };

    const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
    const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
    const goToday = () => setCurrentDate(new Date());

    return (
        <div className="glass-panel rounded-2xl overflow-hidden">
            <div className="p-4 border-b border-white/50 flex justify-between items-center bg-white/40">
                <button onClick={prevMonth} className="p-2 hover:bg-white/60 rounded-lg transition-colors">
                    <Icon name="chevron-left" size={20} />
                </button>
                <div className="flex items-center gap-3">
                    <h3 className="text-lg font-bold text-dream-navy">
                        {year} å¹´ {month + 1} æœˆ
                    </h3>
                    <button onClick={goToday} className="text-xs bg-dream-navy text-white px-3 py-1 rounded-full font-bold hover:bg-[#4A3D35] transition-colors">
                        ä»Šå¤©
                    </button>
                </div>
                <button onClick={nextMonth} className="p-2 hover:bg-white/60 rounded-lg transition-colors">
                    <Icon name="chevron-right" size={20} />
                </button>
            </div>
            
            <div className="grid grid-cols-7 border-b border-white/50">
                {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => (
                    <div key={d} className="p-2 text-center text-xs font-bold text-gray-500 bg-white/40">
                        {d}
                    </div>
                ))}
            </div>
            
            <div className="grid grid-cols-7">
                {days.map((day, idx) => {
                    const dayBookings = getBookingsForDay(day);
                    const isToday = day && new Date().toDateString() === new Date(year, month, day).toDateString();
                    
                    return (
                        <div key={idx} className={`min-h-[80px] border-r border-b border-white/50 p-1 ${!day ? 'bg-white/20' : ''} ${isToday ? 'bg-dream-gold/20' : ''}`}>
                            {day && (
                                <>
                                    <div className={`text-xs font-bold mb-1 ${isToday ? 'text-dream-navy' : 'text-gray-600'}`}>
                                        {day}
                                    </div>
                                    <div className="space-y-1 max-h-16 overflow-y-auto">
                                        {dayBookings.slice(0, 3).map(b => (
                                            <div 
                                                key={b.id} 
                                                onClick={() => onSelectBooking(b)}
                                                className={`calendar-event truncate p-1 rounded text-[10px] cursor-pointer transition-transform hover:scale-105 ${
                                                    b.service_tags?.includes('ä½å®¿') || b.view === 'boarding'
                                                        ? 'bg-orange-100 text-orange-700' 
                                                        : 'bg-blue-100 text-blue-700'
                                                }`}
                                            >
                                                {b.pet_name}
                                            </div>
                                        ))}
                                        {dayBookings.length > 3 && (
                                            <div className="text-[10px] text-gray-400 text-center">
                                                +{dayBookings.length - 3} æ›´å¤š
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

// --- Customer CRM Component ---
const CustomerCRM = ({ bookings, onSelectBooking }) => {
    const [searchTerm, setSearchTerm] = useState('');
    
    const customers = useMemo(() => {
        const grouped = {};
        bookings.forEach(b => {
            const phone = b.phone;
            if (!phone) return;
            if (!grouped[phone]) {
                grouped[phone] = {
                    phone,
                    owner_name: b.owner_name,
                    email: b.raw_data?.email,
                    pets: new Set(),
                    bookings: [],
                    totalSpent: 0
                };
            }
            grouped[phone].bookings.push(b);
            grouped[phone].totalSpent += parseInt(b.service_price) || 0;
            if (b.pet_name) grouped[phone].pets.add(b.pet_name);
        });
        return Object.values(grouped).map(c => ({
            ...c,
            pets: Array.from(c.pets)
        })).sort((a, b) => b.bookings.length - a.bookings.length);
    }, [bookings]);

    const filteredCustomers = customers.filter(c => 
        c.owner_name?.includes(searchTerm) || 
        c.phone?.includes(searchTerm) ||
        c.pets.some(p => p.includes(searchTerm))
    );

    return (
        <div className="glass-panel rounded-2xl overflow-hidden">
            <div className="p-4 border-b border-white/50 bg-white/40">
                <div className="flex items-center gap-3">
                    <Icon name="users" size={20} className="text-dream-navy" />
                    <h3 className="font-bold text-dream-navy">å®¢æˆ¶ç®¡ç† CRM</h3>
                </div>
                <div className="mt-3 relative">
                    <Icon name="search" size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                    <input 
                        type="text" 
                        placeholder="æœå°‹å®¢æˆ¶..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 rounded-lg glass-input text-sm"
                    />
                </div>
            </div>
            <div className="max-h-96 overflow-y-auto">
                {filteredCustomers.map(customer => (
                    <div key={customer.phone} className="p-4 border-b border-white/50 hover:bg-white/60 transition-colors">
                        <div className="flex justify-between items-start">
                            <div>
                                <div className="font-bold text-dream-navy">{customer.owner_name}</div>
                                <div className="text-sm text-gray-500">{customer.phone}</div>
                                <div className="flex flex-wrap gap-1 mt-2">
                                    {customer.pets.map(pet => (
                                        <span key={pet} className="text-xs bg-dream-gold/30 text-dream-navy px-2 py-0.5 rounded-full font-bold">
                                            ğŸ• {pet}
                                        </span>
                                    ))}
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-xs text-gray-500 font-bold bg-white px-2 py-1 rounded">{customer.bookings.length} ç­†è¨‚å–®</div>
                            </div>
                        </div>
                        <div className="mt-3 flex gap-2">
                            {customer.bookings.slice(0, 3).map(b => (
                                <button 
                                    key={b.id}
                                    onClick={() => onSelectBooking(b)}
                                    className="text-xs bg-white/60 px-2 py-1 rounded hover:bg-white transition-colors"
                                >
                                    #{b.id}
                                </button>
                            ))}
                            {customer.bookings.length > 3 && (
                                <span className="text-xs text-gray-400">+{customer.bookings.length - 3}</span>
                            )}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

// --- Activity Log Component ---
const ActivityLog = ({ logs }) => (
    <div className="glass-panel rounded-2xl overflow-hidden">
        <div className="p-4 border-b border-white/50 bg-white/40 flex items-center gap-3">
            <Icon name="activity" size={20} className="text-dream-navy" />
            <h3 className="font-bold text-dream-navy">æ“ä½œæ—¥èªŒ</h3>
        </div>
        <div className="max-h-64 overflow-y-auto">
            {logs.length === 0 ? (
                <div className="p-8 text-center text-gray-400">æš«ç„¡æ“ä½œè¨˜éŒ„</div>
            ) : (
                logs.map((log, idx) => (
                    <div key={idx} className="p-3 border-b border-white/50 text-sm">
                        <div className="flex justify-between">
                            <span className="font-bold text-dream-navy">{log.action}</span>
                            <span className="text-xs text-gray-400">{formatDateTime(log.timestamp)}</span>
                        </div>
                        <div className="text-gray-500 text-xs mt-1">{log.details}</div>
                    </div>
                ))
            )}
        </div>
    </div>
);

// --- Change Password Modal Component ---
const ChangePasswordModal = ({ isOpen, onClose, showToast, currentUserEmail }) => {
    const [oldPassword, setOldPassword] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [targetEmail, setTargetEmail] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        if (isOpen && currentUserEmail) {
            setTargetEmail(currentUserEmail);
            setOldPassword(''); setNewPassword(''); setConfirmPassword('');
        }
    }, [isOpen, currentUserEmail]);

    const handleUpdatePassword = async () => {
        if (!oldPassword) { showToast('è«‹è¼¸å…¥è©²å¸³è™Ÿçš„èˆŠå¯†ç¢¼', 'error'); return; }
        if (newPassword.length < 6) { showToast('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 6 å€‹å­—å…ƒ', 'error'); return; }
        if (newPassword !== confirmPassword) { showToast('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ç›¸ç¬¦', 'error'); return; }
        
        setIsLoading(true);
        try {
            const { error: signInError } = await supabase.auth.signInWithPassword({ email: targetEmail, password: oldPassword });
            if (signInError) throw new Error("èˆŠå¯†ç¢¼è¼¸å…¥éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰èº«åˆ†");

            const { error: updateError } = await supabase.auth.updateUser({ password: newPassword });
            if (updateError) throw updateError;
            
            showToast(`å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼å³å°‡é‡æ–°æ•´ç†...`, 'success');
            
            setTimeout(async () => {
                await supabase.auth.signOut();
                window.location.reload();
            }, 1500);

        } catch (error) {
            showToast(error.message || 'ä¿®æ”¹å¤±æ•—', 'error');
            setIsLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
            <div className="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4">
                <div className="text-center">
                    <h3 className="text-lg font-black text-dream-navy mb-1">è®Šæ›´å¯†ç¢¼</h3>
                    <p className="text-xs text-gray-500">ç›®å‰ä¿®æ”¹å°è±¡ï¼š{targetEmail === ADMIN_EMAIL ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}</p>
                </div>

                {currentUserEmail === ADMIN_EMAIL && (
                    <div className="flex bg-white/60 p-1 rounded-xl">
                        <button onClick={() => setTargetEmail(ADMIN_EMAIL)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${targetEmail === ADMIN_EMAIL ? 'bg-white shadow text-dream-navy' : 'text-gray-500'}`}>ä¿®æ”¹è‡ªå·±</button>
                        <button onClick={() => setTargetEmail(STAFF_EMAIL)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${targetEmail === STAFF_EMAIL ? 'bg-white shadow text-blue-500' : 'text-gray-500'}`}>ä¿®æ”¹å“¡å·¥</button>
                    </div>
                )}

                <div className="space-y-4">
                    <input type="password" value={oldPassword} onChange={(e) => setOldPassword(e.target.value)} className="w-full edit-input py-3" placeholder={`è¼¸å…¥${targetEmail === currentUserEmail ? 'æ‚¨çš„' : 'å°æ–¹çš„'}èˆŠå¯†ç¢¼`} />
                    <hr className="border-dashed border-gray-300" />
                    <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full edit-input py-3" placeholder="æ–°å¯†ç¢¼ (è‡³å°‘6ä½)" />
                    <input type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full edit-input py-3" placeholder="ç¢ºèªæ–°å¯†ç¢¼" />
                </div>
                <div className="flex gap-3 pt-2">
                    <button onClick={onClose} className="flex-1 py-3 rounded-xl bg-white/60 text-gray-600 font-bold hover:bg-white transition-all">å–æ¶ˆ</button>
                    <button onClick={handleUpdatePassword} disabled={isLoading} className="flex-1 py-3 rounded-xl bg-dream-navy text-white font-bold hover:bg-[#4A3D35] disabled:opacity-50 transition-all flex items-center justify-center gap-2">
                        {isLoading ? <Icon name="loader-2" className="animate-spin" /> : 'ç¢ºèªä¿®æ”¹'}
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- Confirm Modal Component ---
const ConfirmModal = ({ isOpen, onClose, onConfirm, title, loading }) => {
    const [confirmPassword, setConfirmPassword] = useState('');
    useEffect(() => { if (!isOpen) setConfirmPassword(''); }, [isOpen]);
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
            <div className="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4">
                <div className="text-center">
                    <div className="w-12 h-12 bg-dream-gold/20 text-dream-navy rounded-full flex items-center justify-center mx-auto mb-3"><Icon name="lock" size={24} /></div>
                    <h3 className="text-lg font-black text-dream-navy">{title}</h3>
                    <p className="text-sm text-gray-500 mt-1">æ­¤ç‚ºæ•æ„Ÿæ“ä½œï¼Œè«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªã€‚</p>
                </div>
                <input type="password" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¯†ç¢¼" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full text-center py-3 border-2 border-gray-200 rounded-xl focus:border-dream-navy outline-none font-bold bg-white" autoFocus />
                <div className="flex gap-3 pt-2">
                    <button onClick={onClose} className="flex-1 py-3 rounded-xl bg-white/60 text-gray-600 font-bold hover:bg-white transition-all">å–æ¶ˆ</button>
                    <button onClick={() => onConfirm(confirmPassword)} disabled={loading || !confirmPassword} className="flex-1 py-3 rounded-xl bg-dream-navy text-white font-bold hover:bg-[#4A3D35] disabled:opacity-50 transition-all flex items-center justify-center gap-2">
                        {loading ? <Icon name="loader-2" className="animate-spin" /> : 'ç¢ºèªåŸ·è¡Œ'}
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- Print Contract Component ---
const PrintContract = ({ data }) => {
    if (!data) return null;
    const r = data.raw_data || {};
    const isBoarding = !!data.checkin_date || (data.view === 'boarding');
    
    return (
        <div id="print-area" className="hidden">
            <div className="max-w-[210mm] mx-auto space-y-4 p-4">
                <div className="flex justify-between items-center border-b-2 border-dream-navy pb-2 mb-4">
                    <h1 className="text-2xl font-black text-dream-navy">å¤¢17ç²¾å“å¯µç‰©ç¾å®¹æ—…é¤¨ | æœå‹™å¥‘ç´„æ›¸</h1>
                    <div className="text-right text-xs">
                        <p>å–®è™Ÿï¼š#{data.id}</p>
                        <p>å¡«è¡¨æ—¥æœŸï¼š{formatDate(data.created_at)}</p>
                    </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1 border p-2 rounded border-dream-navy/20">
                        <h3 className="font-bold border-b pb-1 mb-1 text-dream-navy">ç”²æ–¹ (é£¼ä¸»è³‡æ–™)</h3>
                        <p><strong>å§“å:</strong> {data.owner_name}</p>
                        <p><strong>é›»è©±:</strong> {data.phone}</p>
                        <p><strong>èº«åˆ†è­‰:</strong> {r.owner_id}</p>
                        <p><strong>åœ°å€:</strong> {r.address}</p>
                        <p><strong>Email:</strong> {r.email}</p>
                        <p><strong>ç·Šæ€¥è¯çµ¡:</strong> {r.emergency_name} ({r.emergency_phone})</p>
                    </div>
                    <div className="space-y-1 border p-2 rounded border-dream-navy/20">
                        <h3 className="font-bold border-b pb-1 mb-1 text-dream-navy">ä¹™æ–¹ (å¯µç‰©è³‡æ–™)</h3>
                        <p><strong>åå­—:</strong> {data.pet_name}</p>
                        <p><strong>å“ç¨®:</strong> {r.breed}</p>
                        <p><strong>æ€§åˆ¥/çµç´®:</strong> {r.sex} / {r.fix}</p>
                        <p><strong>å¹´é½¡/é«”é‡:</strong> {r.age_value} {r.age_type === 'year' ? 'æ­²' : 'å€‹æœˆ'} / {r.weight} kg</p>
                        <p><strong>æ™¶ç‰‡:</strong> {r.chip_status} {r.chip_id ? `(${r.chip_id})` : ''}</p>
                    </div>
                </div>
                <div className="border-2 border-dream-navy p-3 rounded mt-2">
                    <h3 className="font-bold text-sm mb-2 text-dream-navy">æœå‹™å…§å®¹ç¢ºèª</h3>
                    <p><strong>é …ç›®:</strong> {data.service_tags?.join(', ') || data.service_type}</p>
                    <p><strong>é‡‘é¡:</strong> NT$ {data.service_price}</p>
                    {isBoarding && (
                        <>
                            <p><strong>å…¥ä½:</strong> {data.checkin_date}</p>
                            <p><strong>é€€æˆ¿:</strong> {data.checkout_date}</p>
                        </>
                    )}
                </div>
                <div className="mt-4 pt-2 border-t-2 border-dream-navy">
                    <p className="text-xs mb-2">æœ¬äººå·²è©³é–±ä¸¦åŒæ„æœ¬é¤¨ä¹‹æœå‹™æ¢æ¬¾ï¼Œç¢ºèªä¸Šè¿°å¡«å¯«è³‡æ–™å±¬å¯¦ç„¡èª¤ã€‚</p>
                    <div className="flex justify-between items-end mt-4">
                        <div className="w-1/2">
                            <p className="font-bold mb-1">é£¼ä¸»ç°½ç½²ï¼š</p>
                            {data.signature ? <img src={data.signature} className="h-16 object-contain border-b border-dashed border-gray-400 w-full" /> : <div className="h-16 border-b border-dashed border-gray-400 w-full"></div>}
                        </div>
                        <div className="text-right"><p className="text-xs">ç°½ç½²æ™‚é–“ï¼š{formatDateTime(data.created_at)}</p></div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- Utility Functions ---
const getServiceLabel = (serviceType, serviceTags) => {
    if (serviceTags && serviceTags.length > 0) {
        return serviceTags.join(', ');
    }
    if (!serviceType) return '';
    if (serviceType.includes('ä½å®¿')) return 'ğŸ  ä½å®¿ï¼‹æ´—æ¾¡';
    return `âœ‚ï¸ ${serviceType}`;
};

const formatDate = (dateStr) => {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleDateString('zh-TW');
};

const formatDateTime = (dateStr) => {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleString('zh-TW');
};

// --- Main App Component ---
const App = () => {
    // --- æ¬Šé™è¨­å®š ---
    const ADMIN_EMAIL = "dream17dream17petshop@gmail.com";
    const STAFF_EMAIL = "staff@dream17.com"; 
    
    // 1. å…ˆæª¢æŸ¥ Supabase æ˜¯å¦è¼‰å…¥
    const [isSupabaseReady, setIsSupabaseReady] = useState(false);
    const [supabase, setSupabase] = useState(null);
    const [session, setSession] = useState(null);
    const [loading, setLoading] = useState(true);
    const [dataLoading, setDataLoading] = useState(false);
    
    // ç™»å…¥ç‹€æ…‹
    const [loginEmail, setLoginEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loginError, setLoginError] = useState('');

    const [bookings, setBookings] = useState([]);
    const [selectedBooking, setSelectedBooking] = useState(null);
    const [selectedBookings, setSelectedBookings] = useState(new Set());
    
    // Filters
    const [searchFilter, setSearchFilter] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [serviceFilter, setServiceFilter] = useState('all');
    const [dateFrom, setDateFrom] = useState('');
    const [dateTo, setDateTo] = useState('');
    
    // View mode
    const [viewMode, setViewMode] = useState('list');
    const [activeTab, setActiveTab] = useState('orders');
    
    // Edit mode
    const [isEditing, setIsEditing] = useState(false);
    const [editForm, setEditForm] = useState({});
    
    // Modals
    const [showConfirm, setShowConfirm] = useState(false);
    const [confirmAction, setConfirmAction] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [showPasswordModal, setShowPasswordModal] = useState(false);
    
    const [toast, setToast] = useState(null);
    const [activityLogs, setActivityLogs] = useState([]);

    // 2. Supabase è¼‰å…¥å®Œæˆå¾Œï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹            
    const getPermissions = (userEmail) => {
        const ADMIN_ROLES = {
            [ADMIN_EMAIL]: {
                role: 'super_admin',
                name: 'ç®¡ç†å“¡',
                permissions: ['view', 'edit', 'delete', 'export', 'settings', 'logs', 'manage_admins']
            },
            [STAFF_EMAIL]: {
                role: 'staff',
                name: 'å“¡å·¥',
                permissions: ['view'] 
            }
        };
        
        const adminConfig = ADMIN_ROLES[userEmail] || { role: 'viewer', permissions: ['view'] };
        
        const hasPermission = (permission) => {
            return adminConfig.permissions.includes(permission);
        };
        
        return {
            role: adminConfig.role,
            roleName: adminConfig.name,
            permissions: adminConfig.permissions,
            hasPermission,
            canEdit: () => hasPermission('edit'),
            canDelete: () => hasPermission('delete'),
            canExport: () => hasPermission('export'),
            canAccessSettings: () => hasPermission('settings'),
            canViewLogs: () => hasPermission('logs'),
            canManageAdmins: () => hasPermission('manage_admins')
        };
    };

    // å–å¾—æ¬Šé™
    const { canEdit, canDelete, roleName, canManageAdmins, canViewLogs, canExport } = getPermissions(session?.user?.email);

    const showToast = (message, type = 'success') => setToast({ message, type });

    const addLog = (action, details) => {
        const newLog = { action, details, timestamp: new Date().toISOString() };
        setActivityLogs(prev => [newLog, ...prev].slice(0, 100));
        localStorage.setItem('activity_logs', JSON.stringify([newLog, ...activityLogs].slice(0, 100)));
    };

    useEffect(() => {
        if (window.supabase) {
            const { createClient } = window.supabase;
            const client = createClient(
                'https://gyqzsroxdqyzldqvulbs.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5cXpzcm94ZHF5emxkcXZ1bGJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NjQyOTEsImV4cCI6MjA4NDI0MDI5MX0.vksBNZ0yxFwG7NBAlfJLs-qpAZGvCivpnpHcp7w5rl0'
            );
            setSupabase(client);
            setIsSupabaseReady(true);
        } else {
            console.error("Supabase library not loaded yet.");
        }
    }, []);

    useEffect(() => {
        const saved = localStorage.getItem('activity_logs');
        if (saved) setActivityLogs(JSON.parse(saved));
    }, []);

    useEffect(() => {
        if (!supabase) return;
        supabase.auth.getSession().then(({ data: { session } }) => {
            setSession(session);
            if(session) fetchBookings();
            setLoading(false);
        });
        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
            setSession(session);
            if(session) fetchBookings();
        });
        return () => subscription.unsubscribe();
    }, [supabase]);

    useEffect(() => {
        if (!session || !supabase) return;
        const channel = supabase
            .channel('bookings-changes')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'bookings' }, (payload) => {
                setBookings(prev => [payload.new, ...prev]);
                showToast(`ğŸ‰ æ–°è¨‚å–®ï¼${payload.new.pet_name} - ${payload.new.owner_name}`, 'success');
                addLog('æ–°è¨‚å–®', `#${payload.new.id} ${payload.new.pet_name}`);
            })
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'bookings' }, (payload) => {
                setBookings(prev => prev.map(b => b.id === payload.new.id ? payload.new : b));
            })
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'bookings' }, (payload) => {
                setBookings(prev => prev.filter(b => b.id !== payload.old.id));
            })
            .subscribe();
        return () => { supabase.removeChannel(channel); };
    }, [session, supabase]);

    // å¦‚æœ Supabase é‚„æ²’å¥½ï¼Œå…ˆé¡¯ç¤ºè¼‰å…¥ä¸­
    if (!isSupabaseReady) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-dream-cream">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-dream-navy mx-auto mb-4"></div>
                    <p className="text-dream-navy font-bold">ç³»çµ±è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        );
    }

    const handleLogin = async (e) => {
        e.preventDefault();
        if (!supabase || !supabase.auth) {
            alert('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
            return;
        }
        
        setLoading(true);
        setLoginError('');
        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: loginEmail,
                password: password, 
            });
            
            if (error) {
                setLoginError(error.message);
                throw error;
            }
            
        } catch (error) {
            console.error('Login error:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleLogout = async () => {
        addLog('ç™»å‡º', 'ä½¿ç”¨è€…ç™»å‡º');
        await supabase.auth.signOut();
        window.location.href = 'dream.html';
    };

    const fetchBookings = async () => {
        setDataLoading(true);
        const { data, error } = await supabase.from('bookings').select('*').order('created_at', { ascending: false });
        if (!error) setBookings(data);
        setDataLoading(false);
    };

    const stats = useMemo(() => {
        const today = new Date().toISOString().split('T')[0];
        return {
            today: bookings.filter(b => b.created_at?.startsWith(today)).length,
            pending: bookings.filter(b => b.status === 'pending').length,
            boarding: bookings.filter(b => b.service_tags?.includes('ä½å®¿') || b.view === 'boarding').length,
            grooming: bookings.filter(b => 
                b.service_tags?.includes('æ´—æ¾¡') || 
                b.service_tags?.includes('å‰ªæ¯›') || 
                b.view === 'grooming'
            ).length,
            daycare: bookings.filter(b => b.service_tags?.includes('å®‰è¦ª')).length,
            total: bookings.length
        };
    }, [bookings]);

    const filteredBookings = useMemo(() => {
        return bookings.filter(b => {
            if (searchFilter && !(
                b.owner_name?.includes(searchFilter) || 
                b.pet_name?.includes(searchFilter) || 
                b.phone?.includes(searchFilter)
            )) return false;
            
            if (statusFilter !== 'all' && b.status !== statusFilter) return false;
            
            if (serviceFilter !== 'all') {
                if (serviceFilter === 'boarding' && !b.service_tags?.includes('ä½å®¿') && b.view !== 'boarding') return false;
                if (serviceFilter === 'grooming' && !b.service_tags?.includes('æ´—æ¾¡') && !b.service_tags?.includes('å‰ªæ¯›') && b.view !== 'grooming') return false;
            }
            
            if (dateFrom && b.created_at < dateFrom) return false;
            if (dateTo && b.created_at > dateTo + 'T23:59:59') return false;
            
            return true;
        });
    }, [bookings, searchFilter, statusFilter, serviceFilter, dateFrom, dateTo]);

    const updateStatus = async (id, newStatus) => {
        const currentBooking = bookings.find(b => b.id === id);
        const oldStatus = currentBooking?.status || 'pending';
        if (oldStatus === newStatus) return;
        
        const newHistoryEntry = {
            from: oldStatus,
            to: newStatus,
            changed_at: new Date().toISOString(),
            changed_by: session?.user?.email || 'unknown'
        };
        
        const updatedRawData = {
            ...currentBooking?.raw_data,
            status_history: [...(currentBooking?.raw_data?.status_history || []), newHistoryEntry]
        };
        
        const { data, error } = await supabase
            .from('bookings')
            .update({ status: newStatus, raw_data: updatedRawData })
            .eq('id', id)
            .select();
        
        if (!error && data) {
            const updatedBooking = data[0];
            setBookings(prev => prev.map(b => b.id === id ? updatedBooking : b));
            if (selectedBooking?.id === id) setSelectedBooking(updatedBooking);
            addLog('ç‹€æ…‹æ›´æ–°', `#${id} ${oldStatus} â†’ ${newStatus}`);
            showToast('ç‹€æ…‹å·²æ›´æ–°', 'success');
        } else {
            showToast('ç‹€æ…‹æ›´æ–°å¤±æ•—', 'error');
        }
    };

    const handleBatchStatusUpdate = async (newStatus) => {
        if (selectedBookings.size === 0) return;
        const ids = Array.from(selectedBookings);
        const { error } = await supabase.from('bookings').update({ status: newStatus }).in('id', ids);
        if (!error) {
            setBookings(prev => prev.map(b => ids.includes(b.id) ? { ...b, status: newStatus } : b));
            setSelectedBookings(new Set());
            addLog('æ‰¹æ¬¡æ›´æ–°', `${ids.length} ç­†è¨‚å–® â†’ ${newStatus}`);
            showToast(`å·²æ›´æ–° ${ids.length} ç­†è¨‚å–®`, 'success');
        }
    };

    const toggleSelectBooking = (id) => {
        setSelectedBookings(prev => {
            const newSet = new Set(prev);
            if (newSet.has(id)) newSet.delete(id);
            else newSet.add(id);
            return newSet;
        });
    };

    const selectAllBookings = () => {
        if (selectedBookings.size === filteredBookings.length) {
            setSelectedBookings(new Set());
        } else {
            setSelectedBookings(new Set(filteredBookings.map(b => b.id)));
        }
    };

    const triggerAction = (action) => { 
        if (action === 'save' && !canEdit()) {
            showToast("æ¬Šé™ä¸è¶³ï¼šç„¡æ³•ç·¨è¼¯", "error");
            return;
        }
        if (action === 'delete' && !canDelete()) {
            showToast("æ¬Šé™ä¸è¶³ï¼šç„¡æ³•åˆªé™¤", "error");
            return;
        }
        setConfirmAction(action); 
        setShowConfirm(true); 
    };

    const executeAction = async (confirmPassword) => {
        setActionLoading(true);
        // é©—è­‰ç•¶å‰ç™»å…¥è€…çš„å¯†ç¢¼
        const { error: authError } = await supabase.auth.signInWithPassword({ email: loginEmail, password: confirmPassword });
        
        if (authError) { 
            showToast("å¯†ç¢¼éŒ¯èª¤", 'error'); 
            setActionLoading(false); 
            return; 
        }

        if (confirmAction === 'save') {
            if (canEdit()) await handleSaveLogic();
            else showToast("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•å„²å­˜", 'error');
        }
        else if (confirmAction === 'delete') {
            if (canDelete()) await handleDeleteLogic();
            else showToast("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åˆªé™¤", 'error');
        }
        setActionLoading(false); 
        setShowConfirm(false);
    };

    const handleDeleteLogic = async () => {
        const { error } = await supabase.from('bookings').delete().eq('id', selectedBooking.id);
        if (!error) {
            setBookings(prev => prev.filter(b => b.id !== selectedBooking.id));
            addLog('åˆªé™¤è¨‚å–®', `#${selectedBooking.id} ${selectedBooking.pet_name}`);
            setSelectedBooking(null);
            showToast('è¨‚å–®å·²åˆªé™¤', 'success');
        } else { showToast("åˆªé™¤å¤±æ•—", 'error'); }
    };

    const startEditing = () => {
        if (!canEdit()) {
            showToast("æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ", "error");
            return;
        }
        setEditForm({ ...selectedBooking, ...selectedBooking.raw_data });
        setIsEditing(true);
    };

    const handleEditChange = (field, value) => { setEditForm(prev => ({ ...prev, [field]: value })); };

    const handleSaveLogic = async () => {
        const sanitizeDate = (val) => (!val || val === '') ? null : val;
        const topLevelUpdates = {
            owner_name: editForm.owner_name,
            phone: editForm.phone,
            pet_name: editForm.pet_name,
            service_type: editForm.service_type,
            checkin_date: sanitizeDate(editForm.checkin_date),
            checkout_date: sanitizeDate(editForm.checkout_date),
            pickup_time: editForm.pickup_time,
            service_price: editForm.service_price
        };
        const newRawData = { ...selectedBooking.raw_data, ...editForm };
        ['id', 'created_at', 'status', 'raw_data', 'signature_url', 'vaccine_url'].forEach(k => delete newRawData[k]);

        const { data, error } = await supabase.from('bookings')
            .update({ ...topLevelUpdates, raw_data: newRawData })
            .eq('id', selectedBooking.id)
            .select();

        if (!error && data) {
            const updatedBooking = data[0];
            setBookings(prev => prev.map(b => b.id === updatedBooking.id ? updatedBooking : b));
            setSelectedBooking(updatedBooking);
            setIsEditing(false);
            addLog('ç·¨è¼¯è¨‚å–®', `#${updatedBooking.id} ${updatedBooking.pet_name}`);
            showToast('å„²å­˜æˆåŠŸ', 'success');
        } else { showToast("å„²å­˜å¤±æ•—", 'error'); }
    };

    const exportToExcel = (bookings, filename = 'bookings') => {
        const data = bookings.map(b => ({
            'è¨‚å–®ç·¨è™Ÿ': b.id,
            'å»ºç«‹æ™‚é–“': formatDateTime(b.created_at),
            'é£¼ä¸»å§“å': b.owner_name,
            'é›»è©±': b.phone,
            'å¯µç‰©åå­—': b.pet_name,
            'æœå‹™é …ç›®': b.service_tags?.join(', ') || b.service_type,
            'ç‹€æ…‹': b.status,
            'å…¥ä½æ—¥æœŸ': b.checkin_date || '',
            'é€€æˆ¿æ—¥æœŸ': b.checkout_date || ''
        }));
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'è¨‚å–®');
        XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
    };

    // --- Render ---
    if (!session) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 relative">
                <div className="absolute top-[10%] left-[-10%] w-72 h-72 bg-dream-gold opacity-10 rounded-full blur-[80px] animate-blob"></div>
                <div className="absolute bottom-[10%] right-[-10%] w-80 h-80 bg-dream-navy opacity-[0.07] rounded-full blur-[100px] animate-blob" style={{ animationDelay: '3s' }}></div>
                <div className="w-full max-w-[500px] flex flex-col items-center z-10 p-6 md:p-8 rounded-[40px] glass-panel animate-fade-up">
                    <header className="flex flex-col items-center mb-6 text-center">
                        <img src="logo.png" className="w-56 h-auto object-contain mb-4 hover:scale-105 transition-transform duration-500" alt="Dream 17" />
                        <div className="space-y-0.5">
                            <h1 className="text-xl font-bold tracking-[0.1em] text-dream-navy">å¤¢17ç²¾å“å¯µç‰©ç¾å®¹æ—…é¤¨</h1>
                            <p className="text-[10px] text-dream-gold font-bold tracking-[0.3em] uppercase opacity-80">Forever Family</p>
                        </div>
                    </header>
                    {!loginEmail ? (
                        <div className="space-y-4 w-full">
                            <p className="text-center text-gray-500 text-sm mb-8">è«‹é¸æ“‡ç™»å…¥èº«åˆ†</p>
                            <button onClick={() => setLoginEmail(ADMIN_EMAIL)} className="glass-button group w-full p-5 rounded-[24px] flex items-center justify-between cursor-pointer">
                                <div className="flex items-center gap-5 relative z-10">
                                    <div className="w-14 h-14 flex items-center justify-center rounded-[20px] bg-white text-dream-navy shadow-[0_4px_20px_rgba(235,235,235,1)] group-hover:scale-110 transition-transform duration-500">
                                        <Icon name="shield" size={24} />
                                    </div>
                                    <div className="text-left space-y-0.5">
                                        <span className="text-[10px] font-bold text-dream-gold tracking-[0.2em] uppercase">Admin</span>
                                        <h3 className="font-bold text-[19px] text-dream-navy group-hover:text-dream-gold/90 transition-colors">ç®¡ç†å“¡ç™»å…¥</h3>
                                        <p className="text-[12px] text-gray-400 font-medium tracking-wide">æ“æœ‰å®Œæ•´æ¬Šé™</p>
                                    </div>
                                </div>
                                <div className="text-dream-gold/30 group-hover:text-dream-gold group-hover:translate-x-1 transition-all duration-300 relative z-10">
                                    <Icon name="arrow-right" size={20} />
                                </div>
                            </button>
                            <button onClick={() => setLoginEmail(STAFF_EMAIL)} className="glass-button group w-full p-5 rounded-[24px] flex items-center justify-between cursor-pointer">
                                <div className="flex items-center gap-5 relative z-10">
                                    <div className="w-14 h-14 flex items-center justify-center rounded-[20px] bg-white text-dream-navy shadow-[0_4px_20px_rgba(235,235,235,1)] group-hover:scale-110 transition-transform duration-500">
                                        <Icon name="user" size={24} />
                                    </div>
                                    <div className="text-left space-y-0.5">
                                        <span className="text-[10px] font-bold text-dream-gold tracking-[0.2em] uppercase">Staff</span>
                                        <h3 className="font-bold text-[19px] text-dream-navy group-hover:text-dream-gold/90 transition-colors">å“¡å·¥ç™»å…¥</h3>
                                        <p className="text-[12px] text-gray-400 font-medium tracking-wide">åƒ…é™æª¢è¦–</p>
                                    </div>
                                </div>
                                <div className="text-dream-gold/30 group-hover:text-dream-gold group-hover:translate-x-1 transition-all duration-300 relative z-10">
                                    <Icon name="arrow-right" size={20} />
                                </div>
                            </button>
                        </div>
                    ) : (
                        <form onSubmit={handleLogin} className="space-y-4 w-full fade-in">
                            <div className="text-center mb-6">
                                <span className={`inline-block px-4 py-1 rounded-full text-xs font-bold mb-2 ${loginEmail === ADMIN_EMAIL ? 'bg-dream-navy text-white' : 'bg-blue-500 text-white'}`}>
                                    {loginEmail === ADMIN_EMAIL ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}
                                </span>
                                <p className="text-lg font-bold text-dream-navy">{loginEmail === ADMIN_EMAIL ? 'æ­¡è¿å›ä¾†ï¼Œåº—é•·ï¼' : 'ä¸Šç­åŠ æ²¹ï¼'}</p>
                            </div>
                            <div className="relative">
                                <Icon name="lock" size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" />
                                <input type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full pl-12 pr-4 py-4 rounded-xl glass-input text-lg font-bold text-center tracking-widest placeholder:tracking-normal" autoFocus />
                            </div>
                            {loginError && <p className="text-dream-red text-sm font-bold animate-pulse text-center">{loginError}</p>}
                            <button disabled={loading} className="w-full py-4 rounded-[24px] bg-dream-navy text-white text-lg font-bold shadow-xl shadow-dream-navy/30 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                                {loading ? <Icon name="loader-2" className="animate-spin" /> : <>ç¢ºèªç™»å…¥ <Icon name="arrow-right" size={20} /></>}
                            </button>
                            <button type="button" onClick={() => { setLoginEmail(''); setPassword(''); setLoginError(''); }} className="w-full py-2 text-gray-400 hover:text-dream-navy text-sm font-bold transition-colors">
                                â† åˆ‡æ›ä½¿ç”¨è€…
                            </button>
                        </form>
                    )}
                    <div className="mt-6 border-t border-white/50 pt-4">
                        <a href="dream.html" className="w-full py-3 rounded-xl font-bold text-gray-400 hover:text-dream-navy transition-all flex items-center justify-center gap-2 text-sm">
                            <Icon name="arrow-left" size={16} /> è¿”å›å¡«å¯«é¦–é 
                        </a>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-dream-cream pb-32">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            
            <nav className="glass-nav fixed top-0 left-0 w-full z-40 transition-all duration-300 py-3">
                <div className="max-w-7xl mx-auto px-6 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <img src="logo.png" className="h-10" alt="Logo" />
                        <span className="font-bold text-lg text-dream-navy tracking-widest">å¾Œå°ç®¡ç†</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <button onClick={fetchBookings} className="p-2 rounded-full hover:bg-white/60 text-dream-navy transition-colors">
                            <Icon name="rotate-cw" size={20} className={dataLoading ? "animate-spin" : ""} />
                        </button>
                        {canManageAdmins() && (
                            <button onClick={() => setShowPasswordModal(true)} className="p-2 rounded-full hover:bg-white/60 text-dream-navy transition-colors">
                                <Icon name="key" size={20} />
                            </button>
                        )}
                        <button onClick={handleLogout} className="p-2 rounded-full hover:bg-red-50 text-dream-navy hover:text-dream-red transition-colors">
                            <Icon name="log-out" size={20} />
                        </button>
                    </div>
                </div>
            </nav>

            <main className="pt-24 px-4 max-w-7xl mx-auto space-y-6 animate-fade-in">
                {/* Stats Cards */}
                <div className="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
                    {[
                        { title: 'ä»Šæ—¥æ–°å¢', count: stats.today, icon: 'plus-circle', bgColor: 'bg-blue-50', textColor: 'text-blue-500' },
                        { title: 'å¾…è™•ç†', count: stats.pending, icon: 'alert-circle', bgColor: 'bg-yellow-50', textColor: 'text-yellow-500' },
                        { title: 'ä½å®¿é ç´„', count: stats.boarding, icon: 'home', bgColor: 'bg-orange-50', textColor: 'text-orange-500' },
                        { title: 'æ´—æ¾¡ç¾å®¹', count: stats.grooming, icon: 'scissors', bgColor: 'bg-pink-50', textColor: 'text-pink-500' },
                        { title: 'å¯µç‰©å®‰è¦ª', count: stats.daycare, icon: 'sun', bgColor: 'bg-teal-50', textColor: 'text-teal-500' },
                        { title: 'ç¸½è¨‚å–®æ•¸', count: stats.total, icon: 'file-text', bgColor: 'bg-purple-50', textColor: 'text-purple-500' }
                    ].map((item, idx) => (
                        <div key={idx} className="glass-panel p-4 rounded-2xl flex flex-col justify-between h-28">
                            <div className="flex justify-between items-start">
                                <div className="text-xs text-gray-500 font-bold uppercase tracking-wider">{item.title}</div>
                                <div className={`${item.bgColor} ${item.textColor} p-1.5 rounded-lg`}><Icon name={item.icon} size={16}/></div>
                            </div>
                            <div className="text-2xl font-black text-dream-navy">{item.count}</div>
                        </div>
                    ))}
                </div>

                {/* Tabs */}
                <div className="flex gap-1 border-b border-white/50 overflow-x-auto">
                    <button onClick={() => setActiveTab('orders')} className={`px-4 py-3 font-bold text-sm flex items-center gap-2 transition-colors ${activeTab === 'orders' ? 'border-b-3 border-dream-navy text-dream-navy' : 'text-gray-400 hover:text-dream-navy'}`}>
                        <Icon name="clipboard-list" size={16} /> è¨‚å–®ç®¡ç†
                    </button>
                    <button onClick={() => setActiveTab('dashboard')} className={`px-4 py-3 font-bold text-sm flex items-center gap-2 transition-colors ${activeTab === 'dashboard' ? 'border-b-3 border-dream-navy text-dream-navy' : 'text-gray-400 hover:text-dream-navy'}`}>
                        <Icon name="bar-chart-2" size={16} /> æ•¸æ“šå„€è¡¨æ¿
                    </button>
                    {canViewLogs() && (
                        <button onClick={() => setActiveTab('logs')} className={`px-4 py-3 font-bold text-sm flex items-center gap-2 transition-colors ${activeTab === 'logs' ? 'border-b-3 border-dream-navy text-dream-navy' : 'text-gray-400 hover:text-dream-navy'}`}>
                            <Icon name="activity" size={16} /> æ“ä½œæ—¥èªŒ
                        </button>
                    )}
                </div>

                {/* Content */}
                {activeTab === 'orders' && (
                    <div className="space-y-4">
                        <div className="glass-panel p-4 rounded-2xl">
                            <div className="flex flex-wrap gap-3">
                                <div className="relative flex-1 min-w-[200px]">
                                    <Icon name="search" size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                                    <input type="text" placeholder="æœå°‹é›»è©±ã€å¯µç‰©åã€é£¼ä¸»..." value={searchFilter} onChange={e => setSearchFilter(e.target.value)} className="w-full pl-10 pr-4 py-2 rounded-lg glass-input text-sm" />
                                </div>
                                <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="px-3 py-2 rounded-lg glass-input text-sm font-bold">
                                    <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                                    <option value="pending">å¾…è™•ç†</option>
                                    <option value="confirmed">å·²ç¢ºèª</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                    <option value="cancelled">å·²å–æ¶ˆ</option>
                                </select>
                                <select value={serviceFilter} onChange={e => setServiceFilter(e.target.value)} className="px-3 py-2 rounded-lg glass-input text-sm font-bold">
                                    <option value="all">å…¨éƒ¨æœå‹™</option>
                                    <option value="boarding">ğŸ  ä½å®¿</option>
                                    <option value="grooming">âœ‚ï¸ ç¾å®¹</option>
                                </select>
                                <input type="date" value={dateFrom} onChange={e => setDateFrom(e.target.value)} className="px-3 py-2 rounded-lg glass-input text-sm" />
                                <input type="date" value={dateTo} onChange={e => setDateTo(e.target.value)} className="px-3 py-2 rounded-lg glass-input text-sm" />
                            </div>
                            
                            <div className="flex justify-between items-center mt-4 pt-4 border-t border-white/50">
                                <div className="flex gap-2">
                                    {['list', 'calendar', 'crm'].map(mode => (
                                        <button 
                                            key={mode}
                                            onClick={() => setViewMode(mode)}
                                            className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${viewMode === mode ? 'bg-dream-navy text-white' : 'bg-white/60 text-gray-500 hover:bg-white'}`}
                                        >
                                            <Icon name={mode === 'list' ? 'list' : mode === 'calendar' ? 'calendar' : 'users'} size={14} className="inline mr-1" />
                                            {mode === 'list' ? 'åˆ—è¡¨' : mode === 'calendar' ? 'æ—¥æ›†' : 'CRM'}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    {selectedBookings.size > 0 && (
                                        <>
                                            <span className="text-xs text-gray-500 self-center">å·²é¸ {selectedBookings.size} ç­†</span>
                                            <select onChange={e => { if(e.target.value) handleBatchStatusUpdate(e.target.value); e.target.value = ''; }} className="px-2 py-1 rounded-lg glass-input text-xs font-bold">
                                                <option value="">æ‰¹æ¬¡æ›´æ”¹ç‹€æ…‹...</option>
                                                <option value="pending">å¾…è™•ç†</option>
                                                <option value="confirmed">å·²ç¢ºèª</option>
                                                <option value="completed">å·²å®Œæˆ</option>
                                                <option value="cancelled">å·²å–æ¶ˆ</option>
                                            </select>
                                        </>
                                    )}
                                    {canExport() && (
                                        <button onClick={() => exportToExcel(filteredBookings)} className="px-3 py-1.5 rounded-lg bg-green-50 text-green-600 text-xs font-bold hover:bg-green-100 transition-colors flex items-center gap-1">
                                            <Icon name="file-spreadsheet" size={14} /> åŒ¯å‡º Excel
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        {dataLoading ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {[1,2,3,4,5,6].map(i => <SkeletonCard key={i} />)}
                            </div>
                        ) : viewMode === 'calendar' ? (
                            <CalendarView bookings={filteredBookings} onSelectBooking={b => { setSelectedBooking(b); setIsEditing(false); }} />
                        ) : viewMode === 'crm' ? (
                            <CustomerCRM bookings={bookings} onSelectBooking={b => { setSelectedBooking(b); setIsEditing(false); }} />
                        ) : (
                            <div className="glass-panel rounded-2xl overflow-hidden">
                                <div className="md:hidden p-4 space-y-3">
                                    {filteredBookings.map(b => (
                                        <div key={b.id} className="bg-white/60 p-4 rounded-xl flex items-center gap-3">
                                            <input type="checkbox" checked={selectedBookings.has(b.id)} onChange={() => toggleSelectBooking(b.id)} className="w-5 h-5 accent-dream-navy" />
                                            <div className="flex-1" onClick={() => { setSelectedBooking(b); setIsEditing(false); }}>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-dream-navy">{b.pet_name}</span>
                                                    <StatusBadge status={b.status} />
                                                </div>
                                                <div className="text-xs text-gray-500">{b.owner_name} â€¢ {getServiceLabel(b.service_type, b.service_tags)}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-[10px] text-gray-400">{formatDate(b.created_at)}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="hidden md:block overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="bg-white/40 text-gray-500 font-bold text-xs uppercase tracking-wider">
                                            <tr>
                                                <th className="px-4 py-3">
                                                    <input type="checkbox" checked={selectedBookings.size === filteredBookings.length && filteredBookings.length > 0} onChange={selectAllBookings} className="w-4 h-4 accent-dream-navy" />
                                                </th>
                                                <th className="px-4 py-3">å»ºç«‹æ™‚é–“</th>
                                                <th className="px-4 py-3">é£¼ä¸» / é›»è©±</th>
                                                <th className="px-4 py-3">å¯µç‰©</th>
                                                <th className="px-4 py-3">æœå‹™é …ç›®</th>
                                                <th className="px-4 py-3">ç‹€æ…‹</th>
                                                <th className="px-4 py-3"></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-white/50">
                                            {filteredBookings.map(b => (
                                                <tr key={b.id} className="hover:bg-dream-gold/5 transition-colors cursor-pointer group">
                                                    <td className="px-4 py-3" onClick={e => e.stopPropagation()}>
                                                        <input type="checkbox" checked={selectedBookings.has(b.id)} onChange={() => toggleSelectBooking(b.id)} className="w-4 h-4 accent-dream-navy" />
                                                    </td>
                                                    <td className="px-4 py-3 text-sm" onClick={() => { setSelectedBooking(b); setIsEditing(false); }}>
                                                        <div className="font-medium text-gray-600">{formatDate(b.created_at)}</div>
                                                        <div className="text-xs text-gray-400">{new Date(b.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                                    </td>
                                                    <td className="px-4 py-3" onClick={() => { setSelectedBooking(b); setIsEditing(false); }}>
                                                        <div className="font-bold text-dream-navy">{b.owner_name}</div>
                                                        <div className="text-xs text-gray-400">{b.phone}</div>
                                                    </td>
                                                    <td className="px-4 py-3" onClick={() => { setSelectedBooking(b); setIsEditing(false); }}>
                                                        <span className="bg-dream-navy/10 text-dream-navy px-2 py-1 rounded text-xs font-bold">{b.pet_name}</span>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm font-bold text-gray-600" onClick={() => { setSelectedBooking(b); setIsEditing(false); }}>
                                                        {getServiceLabel(b.service_type, b.service_tags)}
                                                    </td>
                                                    <td className="px-4 py-3" onClick={() => { setSelectedBooking(b); setIsEditing(false); }}>
                                                        <StatusBadge status={b.status} />
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <button onClick={() => { setSelectedBooking(b); setIsEditing(false); }} className="text-gray-300 group-hover:text-dream-navy transition-colors">
                                                            <Icon name="chevron-right" size={18}/>
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {filteredBookings.length === 0 && (
                                                <tr><td colSpan="8" className="px-6 py-20 text-center text-gray-400">æ²’æœ‰æ‰¾åˆ°ç›¸é—œè¨‚å–®</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {activeTab === 'dashboard' && (
                    <div className="space-y-6">
                        <DashboardCharts bookings={bookings} />
                    </div>
                )}

                {activeTab === 'logs' && (
                    <ActivityLog logs={activityLogs} />
                )}
            </main>

            {/* Booking Detail Modal */}
            {selectedBooking && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-0 md:p-4 bg-black/60 backdrop-blur-sm fade-in" onClick={(e) => { if(e.target === e.currentTarget && !isEditing) setSelectedBooking(null); }}>
                    <div className="bg-white w-full h-full md:h-[90vh] md:max-w-5xl md:rounded-3xl shadow-2xl flex flex-col overflow-hidden">
                        <div className="px-6 py-4 border-b border-white/50 flex justify-between items-center bg-white/40 shrink-0">
                            <div>
                                <h2 className="text-xl font-black text-dream-navy">è¨‚å–® #{selectedBooking.id}</h2>
                                <p className="text-gray-400 text-xs">{isEditing ? 'ç·¨è¼¯æ¨¡å¼' : formatDateTime(selectedBooking.created_at)}</p>
                            </div>
                            <div className="flex gap-2">
                                {isEditing ? (
                                    <>
                                        <button onClick={() => triggerAction('save')} className="bg-green-500 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-green-600 transition-all text-sm"><Icon name="save" size={16}/> å„²å­˜</button>
                                        <button onClick={() => setIsEditing(false)} className="bg-white/60 text-gray-600 px-4 py-2 rounded-xl font-bold hover:bg-white transition-all text-sm">å–æ¶ˆ</button>
                                    </>
                                ) : (
                                    <>
                                        {canEdit() && (
                                            <button onClick={startEditing} className="bg-blue-50 text-blue-600 px-3 py-2 rounded-xl font-bold flex items-center gap-1 hover:bg-blue-100 transition-all text-sm"><Icon name="pencil" size={14}/> ç·¨è¼¯</button>
                                        )}
                                        <button onClick={() => window.print()} className="bg-white/60 text-gray-600 px-3 py-2 rounded-xl font-bold flex items-center gap-1 hover:bg-white transition-all text-sm"><Icon name="printer" size={14}/></button>
                                        <button onClick={() => setSelectedBooking(null)} className="w-10 h-10 bg-white/60 rounded-full flex items-center justify-center hover:bg-red-50 hover:text-dream-red transition-all"><Icon name="x" size={18}/></button>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 md:p-6 bg-dream-cream">
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 space-y-4">
                                    {/* é£¼ä¸»è³‡æ–™ */}
                                    <div className="glass-panel p-4 rounded-2xl">
                                        <h3 className="font-bold text-dream-navy flex items-center gap-2 mb-4"><Icon name="user" size={16}/> é£¼ä¸»è³‡æ–™</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            <DetailItem label="å§“å" value={selectedBooking.owner_name} fieldName="owner_name" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="é›»è©±" value={selectedBooking.phone} fieldName="phone" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="èº«åˆ†è­‰" value={selectedBooking.raw_data?.owner_id} fieldName="owner_id" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="Email" value={selectedBooking.raw_data?.email} fieldName="email" fullWidth isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="åœ°å€" value={selectedBooking.raw_data?.address} fieldName="address" fullWidth isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="ç·Šæ€¥è¯çµ¡äºº" value={selectedBooking.raw_data?.emergency_name} fieldName="emergency_name" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="ç·Šæ€¥é›»è©±" value={selectedBooking.raw_data?.emergency_phone} fieldName="emergency_phone" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                        </div>
                                    </div>

                                    {/* å¯µç‰©è³‡æ–™ */}
                                    <div className="glass-panel p-4 rounded-2xl">
                                        <h3 className="font-bold text-dream-navy flex items-center gap-2 mb-4"><Icon name="heart" size={16}/> å¯µç‰©è³‡æ–™</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <DetailItem label="åå­—" value={selectedBooking.pet_name} fieldName="pet_name" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="å“ç¨®" value={selectedBooking.raw_data?.breed} fieldName="breed" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="æ€§åˆ¥" value={selectedBooking.raw_data?.sex} fieldName="sex" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="çµç´®" value={selectedBooking.raw_data?.fix} fieldName="fix" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="å¹´é½¡" value={`${selectedBooking.raw_data?.age_value} ${selectedBooking.raw_data?.age_type === 'year' ? 'æ­²' : 'å€‹æœˆ'}`} fieldName="age_value" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="é«”é‡" value={selectedBooking.raw_data?.weight} fieldName="weight" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="æ™¶ç‰‡" value={selectedBooking.raw_data?.chip_status} fieldName="chip_status" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="æ™¶ç‰‡è™Ÿç¢¼" value={selectedBooking.raw_data?.chip_id} fieldName="chip_id" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                        </div>
                                    </div>

                                    {/* æœå‹™è³‡è¨Š */}
                                    <div className="glass-panel p-4 rounded-2xl">
                                        <h3 className="font-bold text-dream-navy flex items-center gap-2 mb-4"><Icon name="scissors" size={16}/> æœå‹™è³‡è¨Š</h3>
                                        <div className="space-y-3">
                                            <DetailItem label="æœå‹™é …ç›®" value={selectedBooking.service_tags?.join(', ') || selectedBooking.service_type} fieldName="service_type" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="é‡‘é¡" value={selectedBooking.service_price} fieldName="service_price" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="å…¥ä½æ—¥æœŸ" value={selectedBooking.checkin_date} fieldName="checkin_date" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="é€€æˆ¿æ—¥æœŸ" value={selectedBooking.checkout_date} fieldName="checkout_date" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                            <DetailItem label="é è¨ˆæ¥å›" value={selectedBooking.pickup_time} fieldName="pickup_time" isEditing={isEditing} editForm={editForm} handleEditChange={handleEditChange} />
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    {/* è¨‚å–®ç‹€æ…‹ */}
                                    <div className="glass-panel p-4 rounded-2xl">
                                        <label className="text-xs font-bold text-gray-500 mb-3 block">è¨‚å–®ç‹€æ…‹</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {['pending', 'confirmed', 'completed', 'cancelled'].map(status => (
                                                <button key={status} onClick={() => updateStatus(selectedBooking.id, status)} className={`py-2 px-3 rounded-lg font-bold text-sm flex items-center justify-center gap-1 border-2 transition-all ${selectedBooking.status === status ? 'bg-dream-navy text-white border-dream-navy' : 'bg-white/60 text-gray-500 border-gray-200 hover:border-dream-navy/30'}`}>
                                                    <StatusBadge status={status} />
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* ç°½åèˆ‡ç–«è‹— */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="glass-panel p-4 rounded-2xl">
                                            <h4 className="text-xs font-bold text-gray-500 mb-2">å®¢æˆ¶ç°½å</h4>
                                            {selectedBooking.signature ? <img src={selectedBooking.signature} className="w-full h-32 object-contain bg-white/60 rounded-lg" /> : <div className="w-full h-32 bg-white/60 rounded-lg flex items-center justify-center text-gray-300 text-xs">ç„¡ç°½å</div>}
                                        </div>
                                        <div className="glass-panel p-4 rounded-2xl">
                                            <h4 className="text-xs font-bold text-gray-500 mb-2">ç–«è‹—è­‰æ˜</h4>
                                            {selectedBooking.vaccine_url ? <a href={selectedBooking.vaccine_url} target="_blank"><img src={selectedBooking.vaccine_url} className="w-full h-32 object-cover rounded-lg hover:opacity-80 transition-opacity" /></a> : <div className="w-full h-32 bg-white/60 rounded-lg flex items-center justify-center text-gray-300 text-xs">ç„¡ç…§ç‰‡</div>}
                                        </div>
                                    </div>

                                    {/* Delete button */}
                                    {!isEditing && canDelete() && (
                                        <button onClick={() => triggerAction('delete')} className="w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 text-dream-red hover:bg-red-50 transition-all border border-transparent hover:border-red-100">
                                            <Icon name="trash-2" size={16}/> åˆªé™¤æ­¤è¨‚å–®
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    <PrintContract data={selectedBooking} />
                </div>
            )}

            <ChangePasswordModal isOpen={showPasswordModal} onClose={() => setShowPasswordModal(false)} showToast={showToast} currentUserEmail={session?.user?.email} />
            <ConfirmModal isOpen={showConfirm} onClose={() => setShowConfirm(false)} onConfirm={executeAction} title={confirmAction === 'delete' ? 'åˆªé™¤ç¢ºèª' : 'å„²å­˜è®Šæ›´ç¢ºèª'} loading={actionLoading} />
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

    </script>
    </body>
</html>